generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String           @id @default(cuid())
  email           String           @unique
  fullName        String
  passwordHash    String
  status          UserStatus       @default(ACTIVE)
  preferredLocale String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  auditLogs       AuditLog[]       @relation("AuditActor")
  sessions        RefreshSession[]
  roles           UserRole[]

  fiscalPeriodsClosed FiscalPeriod[] @relation("FiscalPeriodClosedBy")
  paymentsVoided      Payment[]      @relation("PaymentVoidedBy")

  // Sales
  soCreated  SalesOrder[]      @relation("SoCreatedBy")
  soApproved SalesOrder[]      @relation("SoApprovedBy")
  sdCreated  SalesDelivery[]   @relation("SdCreatedBy")
  ciCreated  CustomerInvoice[] @relation("CiCreatedBy")
  ciPosted   CustomerInvoice[] @relation("CiPostedBy")

  stockMovesCreated StockMove[] @relation("StockMoveCreatedBy")
  stockMovesPosted  StockMove[] @relation("StockMovePostedBy")

  purchaseOrdersCreated  PurchaseOrder[] @relation("PoCreatedBy")
  purchaseOrdersApproved PurchaseOrder[] @relation("PoApprovedBy")

  purchaseReceiptsCreated PurchaseReceipt[] @relation("PrCreatedBy")

  supplierInvoicesCreated SupplierInvoice[] @relation("SiCreatedBy")
  supplierInvoicesPosted  SupplierInvoice[] @relation("SiPostedBy")

  journalEntriesCreated JournalEntry[] @relation("JeCreatedBy")
  journalEntriesPosted  JournalEntry[] @relation("JePostedBy")

  payCreated Payment[] @relation("PayCreatedBy")
  payPosted  Payment[] @relation("PayPostedBy")

  @@index([status])
}

model Role {
  id          String           @id @default(cuid())
  code        String           @unique
  name        String
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  permissions RolePermission[]
  users       UserRole[]
}

model Permission {
  id          String           @id @default(cuid())
  code        String           @unique
  description String?
  roles       RolePermission[]
}

model UserRole {
  userId    String
  roleId    String
  createdAt DateTime @default(now())
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model RolePermission {
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model RefreshSession {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    @unique
  userAgent String?
  ip        String?
  revokedAt DateTime?
  expiresAt DateTime
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model AuditLog {
  id        String      @id @default(cuid())
  actorId   String?
  action    AuditAction
  entity    String
  entityId  String?
  message   String?
  before    Json?
  after     Json?
  ip        String?
  userAgent String?
  createdAt DateTime    @default(now())
  actor     User?       @relation("AuditActor", fields: [actorId], references: [id])

  @@index([actorId])
  @@index([entity, entityId])
  @@index([createdAt])
}

model Currency {
  code     String  @id // "TRY", "USD", "EUR"
  name     String
  symbol   String?
  isBase   Boolean @default(false) // base currency for reporting, typically TRY
  isActive Boolean @default(true)

  purchaseOrders   PurchaseOrder[]
  supplierInvoices SupplierInvoice[]
  salesOrders      SalesOrder[]
  customerInvoices CustomerInvoice[]
  payments         Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ratesFrom ExchangeRate[] @relation("RateFrom")
  ratesTo   ExchangeRate[] @relation("RateTo")

  pricedProducts Product[] @relation("ProductPriceCurrency")
  parties        Party[]
}

model ExchangeRate {
  id       String   @id @default(cuid())
  fromCode String
  toCode   String
  rate     Decimal  @db.Decimal(18, 8) // high precision
  rateDate DateTime // date/time effective (we can treat as day-level in UI)

  source    String? // "manual", "CBRT", etc.
  createdAt DateTime @default(now())

  from Currency @relation("RateFrom", fields: [fromCode], references: [code], onDelete: Restrict)
  to   Currency @relation("RateTo", fields: [toCode], references: [code], onDelete: Restrict)

  @@unique([fromCode, toCode, rateDate])
  @@index([rateDate])
}

model VatRate {
  code     VatRateCode @id
  name     String
  percent  Decimal     @db.Decimal(5, 2) // 20.00
  isActive Boolean     @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchaseOrderLines   PurchaseOrderLine[]
  supplierInvoiceLines SupplierInvoiceLine[]

  soLines              SalesOrderLine[]
  customerInvoiceLines CustomerInvoiceLine[]

  defaultForParties Party[]
  products          Product[]
}

model Unit {
  id       String  @id @default(cuid())
  code     String  @unique // "PCS", "KG", "M"
  name     String
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stockMoveLines       StockMoveLine[]
  purchaseOrderLines   PurchaseOrderLine[]
  purchaseReceiptLines PurchaseReceiptLine[]

  soLines       SalesOrderLine[]
  deliveryLines SalesDeliveryLine[]

  productsAsBaseUnit Product[]
}

model Party {
  id             String    @id @default(cuid())
  type           PartyType
  code           String?   @unique // internal code (optional)
  name           String
  email          String?
  phone          String?
  whatsappNumber String?

  country     String? // "TR"
  city        String?
  addressLine String?

  billingAddress  String?
  shippingAddress String?

  contactPersonName  String?
  contactPersonTitle String?

  taxOffice String?
  taxNumber String?

  // Banking
  iban     String?
  bankName String?
  swift    String?

  // Purchasing relations (as supplier)
  purchaseOrdersAsSupplier PurchaseOrder[]
  supplierInvoices         SupplierInvoice[]

  // Sales relations
  salesOrders      SalesOrder[]
  customerInvoices CustomerInvoice[]
  journalLines     JournalLine[]
  payments         Payment[]

  defaultCurrencyCode String?
  paymentTermsDays    Int?
  creditLimit         Decimal? @db.Decimal(18, 2)
  creditRiskLevel     Int? // 1..5 or internal scoring (we'll validate in API later)

  // VAT default (optional per party)
  defaultVatCode VatRateCode?

  // Turkey e-invoicing placeholders (for later integrations)
  isEInvoiceEnabled Boolean @default(false)
  eInvoiceAlias     String?

  notes    String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  defaultCurrency Currency? @relation(fields: [defaultCurrencyCode], references: [code], onDelete: SetNull)
  defaultVat      VatRate?  @relation(fields: [defaultVatCode], references: [code], onDelete: SetNull)

  contacts PartyContact[]

  @@index([type])
  @@index([isActive])
  @@index([name])
}

model PartyContact {
  id      String @id @default(cuid())
  partyId String

  name      String
  title     String?
  email     String?
  phone     String?
  whatsapp  String?
  notes     String?
  isPrimary Boolean @default(false)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  party Party @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@index([partyId])
}

model Product {
  id          String      @id @default(cuid())
  sku         String      @unique
  barcode     String?     @unique
  name        String
  description String?
  type        ProductType @default(GOODS)

  categoryId    String?
  brand         String?
  hsCode        String?
  originCountry String? // e.g. "TR", "CN"

  baseUnitId String
  vatCode    VatRateCode

  // Optional pricing baseline (we will later introduce price lists)
  purchasePrice     Decimal? @db.Decimal(18, 2)
  salesPrice        Decimal? @db.Decimal(18, 2)
  priceCurrencyCode String? // currency for the above prices

  // Inventory planning
  minStock     Decimal? @db.Decimal(18, 4)
  reorderPoint Decimal? @db.Decimal(18, 4)

  // Physical attributes
  weightKg Decimal? @db.Decimal(18, 4)
  lengthCm Decimal? @db.Decimal(18, 2)
  widthCm  Decimal? @db.Decimal(18, 2)
  heightCm Decimal? @db.Decimal(18, 2)

  stockMoveLines     StockMoveLine[]
  stockLedgerEntries StockLedgerEntry[]

  //stockLedger    StockLedgerEntry[]

  // Tracking flags
  trackLot    Boolean @default(false)
  trackSerial Boolean @default(false)

  purchaseOrderLines   PurchaseOrderLine[]
  purchaseReceiptLines PurchaseReceiptLine[]
  supplierInvoiceLines SupplierInvoiceLine[]

  soLines          SalesOrderLine[]
  deliveryLines    SalesDeliveryLine[]
  customerInvLines CustomerInvoiceLine[]

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  baseUnit Unit    @relation(fields: [baseUnitId], references: [id], onDelete: Restrict)
  vatRate  VatRate @relation(fields: [vatCode], references: [code], onDelete: Restrict)

  category      ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  priceCurrency Currency?        @relation("ProductPriceCurrency", fields: [priceCurrencyCode], references: [code], onDelete: SetNull)

  attachments ProductAttachment[]

  @@index([isActive])
  @@index([name])
}

model ProductCategory {
  id       String  @id @default(cuid())
  code     String? @unique
  name     String
  parentId String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parent   ProductCategory?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children ProductCategory[] @relation("CategoryTree")
  products Product[]

  @@index([parentId])
  @@index([name])
}

model ProductAttachment {
  id        String @id @default(cuid())
  productId String

  fileName  String
  mimeType  String?
  sizeBytes Int?
  url       String // later: could be S3 URL, MinIO, or internal file service
  notes     String?

  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model Warehouse {
  id       String  @id @default(cuid())
  code     String  @unique
  name     String
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ledgerEntries    StockLedgerEntry[]
  purchaseOrders   PurchaseOrder[]
  purchaseReceipts PurchaseReceipt[]

  salesOrders     SalesOrder[]
  salesDeliveries SalesDelivery[]

  locations WarehouseLocation[]
  movesFrom StockMove[]         @relation("FromWarehouse")
  movesTo   StockMove[]         @relation("ToWarehouse")

  @@index([isActive])
}

model WarehouseLocation {
  id          String @id @default(cuid())
  warehouseId String

  code     String
  name     String
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, code])
  @@index([warehouseId])
}

model StockMove {
  id     String          @id @default(cuid())
  type   StockMoveType
  status StockMoveStatus @default(DRAFT)

  documentNo   String   @unique
  documentDate DateTime @default(now())
  notes        String?

  fromWarehouseId String?
  toWarehouseId   String?

  // Optional references for future integrations:
  // sourceModule String? // "PURCHASE", "SALES", "POS", etc.
  // sourceId     String?

  createdById String?
  postedById  String?
  postedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fromWarehouse Warehouse? @relation("FromWarehouse", fields: [fromWarehouseId], references: [id], onDelete: SetNull)
  toWarehouse   Warehouse? @relation("ToWarehouse", fields: [toWarehouseId], references: [id], onDelete: SetNull)

  createdBy User? @relation("StockMoveCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  postedBy  User? @relation("StockMovePostedBy", fields: [postedById], references: [id], onDelete: SetNull)

  lines           StockMoveLine[]
  ledgerEntries   StockLedgerEntry[]
  purchaseReceipt PurchaseReceipt?
  salesDelivery   SalesDelivery?

  @@index([type, status])
  @@index([documentDate])
}

model StockMoveLine {
  id     String @id @default(cuid())
  moveId String

  productId String
  quantity  Decimal @db.Decimal(18, 4)
  unitId    String
  notes     String?

  // Lot/Serial placeholders for later:
  lotNo    String?
  serialNo String?

  createdAt DateTime @default(now())

  move    StockMove @relation(fields: [moveId], references: [id], onDelete: Cascade)
  product Product   @relation(fields: [productId], references: [id], onDelete: Restrict)
  unit    Unit      @relation(fields: [unitId], references: [id], onDelete: Restrict)

  @@index([moveId])
  @@index([productId])
}

model StockLedgerEntry {
  id          String @id @default(cuid())
  moveId      String
  productId   String
  warehouseId String

  quantityIn  Decimal @default(0) @db.Decimal(18, 4)
  quantityOut Decimal @default(0) @db.Decimal(18, 4)

  // Optional for future costing:
  // unitCost Decimal? @db.Decimal(18, 6)
  // currencyCode String?

  createdAt DateTime @default(now())

  move      StockMove @relation(fields: [moveId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Restrict)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Restrict)

  @@index([productId, warehouseId])
  @@index([createdAt])
}

model PurchaseOrder {
  id     String              @id @default(cuid())
  status PurchaseOrderStatus @default(DRAFT)

  documentNo   String   @unique
  documentDate DateTime @default(now())

  supplierId  String
  warehouseId String // where goods will be received

  currencyCode       String
  exchangeRateToBase Decimal? @db.Decimal(18, 8) // optional at order time
  notes              String?

  createdById  String?
  approvedById String?
  approvedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  supplier  Party     @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Restrict)
  currency  Currency  @relation(fields: [currencyCode], references: [code], onDelete: Restrict)

  createdBy  User? @relation("PoCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  approvedBy User? @relation("PoApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)

  lines    PurchaseOrderLine[]
  receipts PurchaseReceipt[]
  invoices SupplierInvoice[]

  @@index([status])
  @@index([documentDate])
  @@index([supplierId])
}

model PurchaseOrderLine {
  id   String @id @default(cuid())
  poId String

  productId String
  unitId    String
  quantity  Decimal @db.Decimal(18, 4)

  unitPrice Decimal     @db.Decimal(18, 4) // in PO currency
  vatCode   VatRateCode

  notes String?

  createdAt DateTime @default(now())

  po      PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)
  product Product       @relation(fields: [productId], references: [id], onDelete: Restrict)
  unit    Unit          @relation(fields: [unitId], references: [id], onDelete: Restrict)
  vatRate VatRate       @relation(fields: [vatCode], references: [code], onDelete: Restrict)

  @@index([poId])
  @@index([productId])
}

model PurchaseReceipt {
  id           String   @id @default(cuid())
  documentNo   String   @unique
  documentDate DateTime @default(now())

  poId        String
  warehouseId String
  stockMoveId String? @unique

  notes       String?
  createdById String?

  createdAt DateTime @default(now())

  po        PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Restrict)
  warehouse Warehouse     @relation(fields: [warehouseId], references: [id], onDelete: Restrict)
  stockMove StockMove?    @relation(fields: [stockMoveId], references: [id], onDelete: SetNull)

  createdBy User? @relation("PrCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  lines PurchaseReceiptLine[]

  @@index([poId])
  @@index([documentDate])
}

model PurchaseReceiptLine {
  id        String @id @default(cuid())
  receiptId String

  productId String
  unitId    String
  quantity  Decimal @db.Decimal(18, 4)

  notes String?

  receipt PurchaseReceipt @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id], onDelete: Restrict)
  unit    Unit            @relation(fields: [unitId], references: [id], onDelete: Restrict)

  @@index([receiptId])
  @@index([productId])
}

model SupplierInvoice {
  id     String                @id @default(cuid())
  status SupplierInvoiceStatus @default(DRAFT)

  documentNo   String   @unique
  documentDate DateTime @default(now())

  supplierId String
  poId       String?

  currencyCode       String
  exchangeRateToBase Decimal? @db.Decimal(18, 8)

  subtotal   Decimal @default(0) @db.Decimal(18, 2)
  vatTotal   Decimal @default(0) @db.Decimal(18, 2)
  grandTotal Decimal @default(0) @db.Decimal(18, 2)

  // notes String?

  createdById String?
  postedById  String?
  postedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  kind       InvoiceKind @default(INVOICE)
  noteOfId   String?
  noteReason String?

  noteOf SupplierInvoice?  @relation("SupplierInvoiceNoteOf", fields: [noteOfId], references: [id], onDelete: SetNull)
  notes  SupplierInvoice[] @relation("SupplierInvoiceNoteOf")

  supplier Party          @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  po       PurchaseOrder? @relation(fields: [poId], references: [id], onDelete: SetNull)
  currency Currency       @relation(fields: [currencyCode], references: [code], onDelete: Restrict)

  createdBy User? @relation("SiCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  postedBy  User? @relation("SiPostedBy", fields: [postedById], references: [id], onDelete: SetNull)

  lines             SupplierInvoiceLine[]
  paymentsAllocated PaymentAllocation[]

  @@index([kind])
  @@index([noteOfId])
  @@index([status])
  @@index([supplierId])
  @@index([documentDate])
}

model SupplierInvoiceLine {
  id        String @id @default(cuid())
  invoiceId String

  productId   String?
  description String
  quantity    Decimal     @db.Decimal(18, 4)
  unitPrice   Decimal     @db.Decimal(18, 4)
  vatCode     VatRateCode

  lineSubtotal Decimal @db.Decimal(18, 2)
  lineVat      Decimal @db.Decimal(18, 2)
  lineTotal    Decimal @db.Decimal(18, 2)

  invoice SupplierInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product?        @relation(fields: [productId], references: [id], onDelete: SetNull)
  vatRate VatRate         @relation(fields: [vatCode], references: [code], onDelete: Restrict)

  @@index([invoiceId])
}

model Account {
  id       String      @id @default(cuid())
  code     String      @unique // e.g. "100", "120", "320"
  name     String
  type     AccountType
  isActive Boolean     @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lines JournalLine[]

  @@index([type])
}

model JournalEntry {
  id     String        @id @default(cuid())
  status JournalStatus @default(DRAFT)

  documentNo   String   @unique // e.g. "JE-20251227-0001"
  documentDate DateTime @default(now())
  description  String?

  sourceType String? // "SupplierInvoice", "CustomerInvoice", "Payment"
  sourceId   String?

  createdById String?
  postedById  String?
  postedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reversalOfId   String?   @unique
  reversedAt     DateTime?
  reversedById   String?
  reversalReason String?

  reversalOf JournalEntry? @relation("JournalReversal", fields: [reversalOfId], references: [id], onDelete: SetNull)
  reversal   JournalEntry? @relation("JournalReversal")

  createdBy User? @relation("JeCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  postedBy  User? @relation("JePostedBy", fields: [postedById], references: [id], onDelete: SetNull)

  lines JournalLine[]

  @@index([status])
  @@index([documentDate])
  @@index([sourceType, sourceId])
}

model JournalLine {
  id        String @id @default(cuid())
  entryId   String
  accountId String

  partyId String?
  party   Party?  @relation(fields: [partyId], references: [id], onDelete: SetNull)

  description String?
  debit       Decimal @default(0) @db.Decimal(18, 2)
  credit      Decimal @default(0) @db.Decimal(18, 2)

  // multi-currency bookkeeping support
  currencyCode   String? // null means base currency
  amountCurrency Decimal? @db.Decimal(18, 2)

  createdAt DateTime @default(now())

  entry   JournalEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  account Account      @relation(fields: [accountId], references: [id], onDelete: Restrict)

  @@index([entryId])
  @@index([accountId])
  @@index([partyId])
}

model SalesOrder {
  id     String           @id @default(cuid())
  status SalesOrderStatus @default(DRAFT)

  documentNo   String   @unique
  documentDate DateTime @default(now())

  customerId  String
  warehouseId String

  currencyCode       String
  exchangeRateToBase Decimal? @db.Decimal(18, 8)
  notes              String?

  creditOverrideReason     String?
  creditCheckedAt          DateTime?
  creditExposureAtApproval Decimal?  @db.Decimal(18, 2)

  createdById  String?
  approvedById String?
  approvedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer  Party     @relation(fields: [customerId], references: [id], onDelete: Restrict)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Restrict)
  currency  Currency  @relation(fields: [currencyCode], references: [code], onDelete: Restrict)

  createdBy  User? @relation("SoCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  approvedBy User? @relation("SoApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)

  lines      SalesOrderLine[]
  deliveries SalesDelivery[]
  invoices   CustomerInvoice[]

  @@index([status])
  @@index([documentDate])
  @@index([customerId])
}

model SalesOrderLine {
  id   String @id @default(cuid())
  soId String

  productId String
  unitId    String
  quantity  Decimal @db.Decimal(18, 4)

  unitPrice Decimal     @db.Decimal(18, 4) // in SO currency
  vatCode   VatRateCode

  notes String?

  createdAt DateTime @default(now())

  so      SalesOrder @relation(fields: [soId], references: [id], onDelete: Cascade)
  product Product    @relation(fields: [productId], references: [id], onDelete: Restrict)
  unit    Unit       @relation(fields: [unitId], references: [id], onDelete: Restrict)
  vatRate VatRate    @relation(fields: [vatCode], references: [code], onDelete: Restrict)

  @@index([soId])
  @@index([productId])
}

model SalesDelivery {
  id           String   @id @default(cuid())
  documentNo   String   @unique
  documentDate DateTime @default(now())

  soId        String
  warehouseId String
  stockMoveId String? @unique

  notes       String?
  createdById String?

  createdAt DateTime @default(now())

  so        SalesOrder @relation(fields: [soId], references: [id], onDelete: Restrict)
  warehouse Warehouse  @relation(fields: [warehouseId], references: [id], onDelete: Restrict)
  stockMove StockMove? @relation(fields: [stockMoveId], references: [id], onDelete: SetNull)

  createdBy User? @relation("SdCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  lines SalesDeliveryLine[]

  @@index([soId])
  @@index([documentDate])
}

model SalesDeliveryLine {
  id         String @id @default(cuid())
  deliveryId String

  productId String
  unitId    String
  quantity  Decimal @db.Decimal(18, 4)

  notes String?

  delivery SalesDelivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)
  product  Product       @relation(fields: [productId], references: [id], onDelete: Restrict)
  unit     Unit          @relation(fields: [unitId], references: [id], onDelete: Restrict)

  @@index([deliveryId])
  @@index([productId])
}

model CustomerInvoice {
  id     String                @id @default(cuid())
  status CustomerInvoiceStatus @default(DRAFT)

  documentNo   String   @unique
  documentDate DateTime @default(now())

  customerId String
  soId       String?

  currencyCode       String
  exchangeRateToBase Decimal? @db.Decimal(18, 8)

  subtotal   Decimal @default(0) @db.Decimal(18, 2)
  vatTotal   Decimal @default(0) @db.Decimal(18, 2)
  grandTotal Decimal @default(0) @db.Decimal(18, 2)

  // notes String?

  createdById String?
  postedById  String?
  postedAt    DateTime?

  kind       InvoiceKind @default(INVOICE)
  noteOfId   String?
  noteReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer Party       @relation(fields: [customerId], references: [id], onDelete: Restrict)
  so       SalesOrder? @relation(fields: [soId], references: [id], onDelete: SetNull)
  currency Currency    @relation(fields: [currencyCode], references: [code], onDelete: Restrict)

  createdBy User? @relation("CiCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  postedBy  User? @relation("CiPostedBy", fields: [postedById], references: [id], onDelete: SetNull)

  noteOf CustomerInvoice?  @relation("CustomerInvoiceNoteOf", fields: [noteOfId], references: [id], onDelete: SetNull)
  notes  CustomerInvoice[] @relation("CustomerInvoiceNoteOf")

  lines             CustomerInvoiceLine[]
  paymentsAllocated PaymentAllocation[]

  @@index([kind])
  @@index([status])
  @@index([customerId])
  @@index([documentDate])
  @@index([noteOfId])
}

model CustomerInvoiceLine {
  id        String @id @default(cuid())
  invoiceId String

  productId   String?
  description String
  quantity    Decimal     @db.Decimal(18, 4)
  unitPrice   Decimal     @db.Decimal(18, 4)
  vatCode     VatRateCode

  lineSubtotal Decimal @db.Decimal(18, 2)
  lineVat      Decimal @db.Decimal(18, 2)
  lineTotal    Decimal @db.Decimal(18, 2)

  invoice CustomerInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product?        @relation(fields: [productId], references: [id], onDelete: SetNull)
  vatRate VatRate         @relation(fields: [vatCode], references: [code], onDelete: Restrict)

  @@index([invoiceId])
}

model Payment {
  id     String        @id @default(cuid())
  status PaymentStatus @default(DRAFT)

  documentNo   String   @unique
  documentDate DateTime @default(now())

  direction PaymentDirection
  method    PaymentMethod

  partyId String // customer or supplier
  notes   String?

  currencyCode       String
  exchangeRateToBase Decimal? @db.Decimal(18, 8)

  amount Decimal @db.Decimal(18, 2)

  createdById String?
  postedById  String?
  postedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  voidOfId   String?   @unique
  voidedAt   DateTime?
  voidedById String?
  voidReason String?

  voidOf   Payment? @relation("PaymentVoid", fields: [voidOfId], references: [id], onDelete: SetNull)
  void     Payment? @relation("PaymentVoid")
  voidedBy User?    @relation("PaymentVoidedBy", fields: [voidedById], references: [id], onDelete: SetNull)

  party    Party    @relation(fields: [partyId], references: [id], onDelete: Restrict)
  currency Currency @relation(fields: [currencyCode], references: [code], onDelete: Restrict)

  createdBy User? @relation("PayCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  postedBy  User? @relation("PayPostedBy", fields: [postedById], references: [id], onDelete: SetNull)

  allocations PaymentAllocation[]

  @@index([status])
  @@index([documentDate])
  @@index([partyId])
}

model PaymentAllocation {
  id        String @id @default(cuid())
  paymentId String

  // Allocation targets (only one should be set)
  customerInvoiceId String?
  supplierInvoiceId String?

  amount Decimal @db.Decimal(18, 2)

  payment         Payment          @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  customerInvoice CustomerInvoice? @relation(fields: [customerInvoiceId], references: [id], onDelete: SetNull)
  supplierInvoice SupplierInvoice? @relation(fields: [supplierInvoiceId], references: [id], onDelete: SetNull)

  @@index([paymentId])
}

model FiscalPeriod {
  id        String             @id @default(cuid())
  code      String             @unique // e.g. "2025-12"
  startDate DateTime
  endDate   DateTime
  status    FiscalPeriodStatus @default(OPEN)

  closedAt   DateTime?
  closedById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  closedBy User? @relation("FiscalPeriodClosedBy", fields: [closedById], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([startDate, endDate])
}

model SystemSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

model DocumentSequence {
  id String @id @default(cuid())

  sequenceCode String // e.g. "JE", "SO", "PAY"
  periodKey    String // e.g. "20251227" (daily) or "2025-12" (monthly)

  nextNumber Int @default(1)

  updatedAt DateTime @updatedAt

  @@unique([sequenceCode, periodKey])
  @@index([sequenceCode])
}

//////////////////////////////////////////////////////

enum UserStatus {
  ACTIVE
  DISABLED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  APPROVE
  REJECT
  POST
  CANCEL
  IMPORT
  EXPORT
}

enum PartyType {
  CUSTOMER
  SUPPLIER
}

enum ProductType {
  GOODS
  SERVICE
}

enum VatRateCode {
  KDV_0
  KDV_1
  KDV_10
  KDV_20
}

enum StockMoveType {
  RECEIPT
  ISSUE
  TRANSFER
  ADJUSTMENT
}

enum StockMoveStatus {
  DRAFT
  POSTED
  CANCELED
}

enum PurchaseOrderStatus {
  DRAFT
  APPROVED
  ORDERED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELED
}

enum SupplierInvoiceStatus {
  DRAFT
  POSTED
  CANCELED
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum JournalStatus {
  DRAFT
  POSTED
  CANCELED
}

enum SalesOrderStatus {
  DRAFT
  APPROVED
  CONFIRMED
  PARTIALLY_DELIVERED
  DELIVERED
  CANCELED
}

enum CustomerInvoiceStatus {
  DRAFT
  POSTED
  CANCELED
}

enum PaymentDirection {
  IN // money received from customer
  OUT // money paid to supplier
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CARD
}

enum PaymentStatus {
  DRAFT
  POSTED
  CANCELED
}

enum FiscalPeriodStatus {
  OPEN
  CLOSED
}

enum InvoiceKind {
  INVOICE
  CREDIT_NOTE
  DEBIT_NOTE
}
