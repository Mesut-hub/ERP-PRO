generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = ${{ secrets.CI_DATABASE_URL }}
}

model User {
  id                      String            @id @default(cuid())
  email                   String            @unique
  fullName                String
  passwordHash            String
  status                  UserStatus        @default(ACTIVE)
  preferredLocale         String?
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  auditLogs               AuditLog[]        @relation("AuditActor")
  ciCreated               CustomerInvoice[] @relation("CiCreatedBy")
  ciPosted                CustomerInvoice[] @relation("CiPostedBy")
  fiscalPeriodsClosed     FiscalPeriod[]    @relation("FiscalPeriodClosedBy")
  journalEntriesCreated   JournalEntry[]    @relation("JeCreatedBy")
  journalEntriesPosted    JournalEntry[]    @relation("JePostedBy")
  payCreated              Payment[]         @relation("PayCreatedBy")
  payPosted               Payment[]         @relation("PayPostedBy")
  paymentsVoided          Payment[]         @relation("PaymentVoidedBy")
  purchaseOrdersApproved  PurchaseOrder[]   @relation("PoApprovedBy")
  purchaseOrdersCreated   PurchaseOrder[]   @relation("PoCreatedBy")
  purchaseReceiptsCreated PurchaseReceipt[] @relation("PrCreatedBy")
  sessions                RefreshSession[]
  sdCreated               SalesDelivery[]   @relation("SdCreatedBy")
  soApproved              SalesOrder[]      @relation("SoApprovedBy")
  soCreated               SalesOrder[]      @relation("SoCreatedBy")
  salesReturnsCreated     SalesReturn[]     @relation("SalesReturnCreatedBy")
  stockMovesCreated       StockMove[]       @relation("StockMoveCreatedBy")
  stockMovesPosted        StockMove[]       @relation("StockMovePostedBy")
  supplierInvoicesCreated SupplierInvoice[] @relation("SiCreatedBy")
  supplierInvoicesPosted  SupplierInvoice[] @relation("SiPostedBy")
  purchaseReturnsCreated  PurchaseReturn[]  @relation("PurchaseReturnCreatedBy")
  roles                   UserRole[]

  @@index([status])
}

model Role {
  id          String           @id @default(cuid())
  code        String           @unique
  name        String
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  permissions RolePermission[]
  users       UserRole[]
}

model Permission {
  id          String           @id @default(cuid())
  code        String           @unique
  description String?
  roles       RolePermission[]
}

model UserRole {
  userId    String
  roleId    String
  createdAt DateTime @default(now())
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model RolePermission {
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model RefreshSession {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    @unique
  userAgent String?
  ip        String?
  revokedAt DateTime?
  expiresAt DateTime
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model AuditLog {
  id        String      @id @default(cuid())
  actorId   String?
  action    AuditAction
  entity    String
  entityId  String?
  message   String?
  before    Json?
  after     Json?
  ip        String?
  userAgent String?
  createdAt DateTime    @default(now())
  actor     User?       @relation("AuditActor", fields: [actorId], references: [id])

  @@index([actorId])
  @@index([entity, entityId])
  @@index([createdAt])
}

model Currency {
  code             String            @id
  name             String
  symbol           String?
  isBase           Boolean           @default(false)
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  customerInvoices CustomerInvoice[]
  ratesFrom        ExchangeRate[]    @relation("RateFrom")
  ratesTo          ExchangeRate[]    @relation("RateTo")
  parties          Party[]
  payments         Payment[]
  pricedProducts   Product[]         @relation("ProductPriceCurrency")
  purchaseOrders   PurchaseOrder[]
  salesOrders      SalesOrder[]
  supplierInvoices SupplierInvoice[]
}

model ExchangeRate {
  id        String   @id @default(cuid())
  fromCode  String
  toCode    String
  rate      Decimal  @db.Decimal(18, 8)
  rateDate  DateTime
  source    String?
  createdAt DateTime @default(now())
  from      Currency @relation("RateFrom", fields: [fromCode], references: [code])
  to        Currency @relation("RateTo", fields: [toCode], references: [code])

  @@unique([fromCode, toCode, rateDate])
  @@index([rateDate])
}

model VatRate {
  code                 VatRateCode           @id
  name                 String
  percent              Decimal               @db.Decimal(5, 2)
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  customerInvoiceLines CustomerInvoiceLine[]
  defaultForParties    Party[]
  products             Product[]
  purchaseOrderLines   PurchaseOrderLine[]
  soLines              SalesOrderLine[]
  supplierInvoiceLines SupplierInvoiceLine[]
}

model Unit {
  id                   String                @id @default(cuid())
  code                 String                @unique
  name                 String
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  productsAsBaseUnit   Product[]
  purchaseOrderLines   PurchaseOrderLine[]
  purchaseReceiptLines PurchaseReceiptLine[]
  purchaseReturnLines  PurchaseReturnLine[]
  deliveryLines        SalesDeliveryLine[]
  soLines              SalesOrderLine[]
  salesReturnLines     SalesReturnLine[]     @relation("SalesReturnLineUnit")
  stockMoveLines       StockMoveLine[]
}

model Party {
  id                       String            @id @default(cuid())
  type                     PartyType
  code                     String?           @unique
  name                     String
  email                    String?
  phone                    String?
  country                  String?
  city                     String?
  addressLine              String?
  taxOffice                String?
  taxNumber                String?
  defaultCurrencyCode      String?
  paymentTermsDays         Int?
  isActive                 Boolean           @default(true)
  createdAt                DateTime          @default(now())
  updatedAt                DateTime          @updatedAt
  bankName                 String?
  billingAddress           String?
  contactPersonName        String?
  contactPersonTitle       String?
  creditLimit              Decimal?          @db.Decimal(18, 2)
  creditRiskLevel          Int?
  defaultVatCode           VatRateCode?
  eInvoiceAlias            String?
  iban                     String?
  isEInvoiceEnabled        Boolean           @default(false)
  notes                    String?
  shippingAddress          String?
  swift                    String?
  whatsappNumber           String?
  customerInvoices         CustomerInvoice[]
  journalLines             JournalLine[]
  defaultCurrency          Currency?         @relation(fields: [defaultCurrencyCode], references: [code])
  defaultVat               VatRate?          @relation(fields: [defaultVatCode], references: [code])
  contacts                 PartyContact[]
  payments                 Payment[]
  purchaseOrdersAsSupplier PurchaseOrder[]
  salesOrders              SalesOrder[]
  supplierInvoices         SupplierInvoice[]

  @@index([type])
  @@index([isActive])
  @@index([name])
}

model PartyContact {
  id        String   @id @default(cuid())
  partyId   String
  name      String
  title     String?
  email     String?
  phone     String?
  whatsapp  String?
  notes     String?
  isPrimary Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  party     Party    @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@index([partyId])
}

model Product {
  id                   String                    @id @default(cuid())
  sku                  String                    @unique
  barcode              String?                   @unique
  name                 String
  description          String?
  type                 ProductType               @default(GOODS)
  baseUnitId           String
  vatCode              VatRateCode
  isActive             Boolean                   @default(true)
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  brand                String?
  categoryId           String?
  heightCm             Decimal?                  @db.Decimal(18, 2)
  hsCode               String?
  lengthCm             Decimal?                  @db.Decimal(18, 2)
  minStock             Decimal?                  @db.Decimal(18, 4)
  originCountry        String?
  priceCurrencyCode    String?
  purchasePrice        Decimal?                  @db.Decimal(18, 2)
  reorderPoint         Decimal?                  @db.Decimal(18, 4)
  salesPrice           Decimal?                  @db.Decimal(18, 2)
  trackLot             Boolean                   @default(false)
  trackSerial          Boolean                   @default(false)
  weightKg             Decimal?                  @db.Decimal(18, 4)
  widthCm              Decimal?                  @db.Decimal(18, 2)
  customerInvLines     CustomerInvoiceLine[]
  inventoryCosts       InventoryCost[]
  baseUnit             Unit                      @relation(fields: [baseUnitId], references: [id])
  category             ProductCategory?          @relation(fields: [categoryId], references: [id])
  priceCurrency        Currency?                 @relation("ProductPriceCurrency", fields: [priceCurrencyCode], references: [code])
  vatRate              VatRate                   @relation(fields: [vatCode], references: [code])
  attachments          ProductAttachment[]
  purchaseOrderLines   PurchaseOrderLine[]
  purchaseReceiptLines PurchaseReceiptLine[]
  deliveryLines        SalesDeliveryLine[]
  soLines              SalesOrderLine[]
  salesReturnLines     SalesReturnLine[]         @relation("SalesReturnLineProduct")
  stockLedgerEntries   StockLedgerEntry[]
  stockMoveLines       StockMoveLine[]
  supplierInvoiceLines SupplierInvoiceLine[]
  fifoLayers           InventoryFifoLayer[]
  fifoAllocations      InventoryFifoAllocation[]
  valuationEntries     InventoryValuationEntry[]
  purchaseReturnLines  PurchaseReturnLine[]

  @@index([isActive])
  @@index([name])
}

model ProductCategory {
  id        String            @id @default(cuid())
  code      String?           @unique
  name      String
  parentId  String?
  isActive  Boolean           @default(true)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  products  Product[]
  parent    ProductCategory?  @relation("CategoryTree", fields: [parentId], references: [id])
  children  ProductCategory[] @relation("CategoryTree")

  @@index([parentId])
  @@index([name])
}

model ProductAttachment {
  id        String   @id @default(cuid())
  productId String
  fileName  String
  mimeType  String?
  sizeBytes Int?
  url       String
  notes     String?
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model Warehouse {
  id               String                    @id @default(cuid())
  code             String                    @unique
  name             String
  isActive         Boolean                   @default(true)
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt
  inventoryCosts   InventoryCost[]
  purchaseOrders   PurchaseOrder[]
  purchaseReceipts PurchaseReceipt[]
  salesDeliveries  SalesDelivery[]
  salesOrders      SalesOrder[]
  salesReturns     SalesReturn[]             @relation("SalesReturnWarehouse")
  ledgerEntries    StockLedgerEntry[]
  movesFrom        StockMove[]               @relation("FromWarehouse")
  movesTo          StockMove[]               @relation("ToWarehouse")
  locations        WarehouseLocation[]
  fifoLayers       InventoryFifoLayer[]
  fifoAllocations  InventoryFifoAllocation[]
  valuationEntries InventoryValuationEntry[]
  purchaseReturns  PurchaseReturn[]

  @@index([isActive])
}

model WarehouseLocation {
  id          String    @id @default(cuid())
  warehouseId String
  code        String
  name        String
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, code])
  @@index([warehouseId])
}

model StockMove {
  id              String             @id @default(cuid())
  type            StockMoveType
  status          StockMoveStatus    @default(DRAFT)
  documentNo      String             @unique
  documentDate    DateTime           @default(now())
  notes           String?
  fromWarehouseId String?
  toWarehouseId   String?
  createdById     String?
  postedById      String?
  postedAt        DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  purchaseReceipt PurchaseReceipt?
  salesDelivery   SalesDelivery?
  salesReturn     SalesReturn?       @relation("SalesReturnStockMove")
  ledgerEntries   StockLedgerEntry[]
  createdBy       User?              @relation("StockMoveCreatedBy", fields: [createdById], references: [id])
  fromWarehouse   Warehouse?         @relation("FromWarehouse", fields: [fromWarehouseId], references: [id])
  postedBy        User?              @relation("StockMovePostedBy", fields: [postedById], references: [id])
  toWarehouse     Warehouse?         @relation("ToWarehouse", fields: [toWarehouseId], references: [id])
  lines           StockMoveLine[]
  purchaseReturn  PurchaseReturn?

  @@index([type, status])
  @@index([documentDate])
}

model StockMoveLine {
  id        String    @id @default(cuid())
  moveId    String
  productId String
  quantity  Decimal   @db.Decimal(18, 4)
  unitId    String
  notes     String?
  lotNo     String?
  serialNo  String?
  createdAt DateTime  @default(now())
  move      StockMove @relation(fields: [moveId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id])
  unit      Unit      @relation(fields: [unitId], references: [id])

  @@index([moveId])
  @@index([productId])
}

model StockLedgerEntry {
  id          String    @id @default(cuid())
  moveId      String
  productId   String
  warehouseId String
  quantityIn  Decimal   @default(0) @db.Decimal(18, 4)
  quantityOut Decimal   @default(0) @db.Decimal(18, 4)
  createdAt   DateTime  @default(now())
  move        StockMove @relation(fields: [moveId], references: [id], onDelete: Cascade)
  product     Product   @relation(fields: [productId], references: [id])
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  @@index([productId, warehouseId])
  @@index([createdAt])
}

model PurchaseOrder {
  id                 String              @id @default(cuid())
  status             PurchaseOrderStatus @default(DRAFT)
  documentNo         String              @unique
  documentDate       DateTime            @default(now())
  supplierId         String
  warehouseId        String
  currencyCode       String
  exchangeRateToBase Decimal?            @db.Decimal(18, 8)
  notes              String?
  createdById        String?
  approvedById       String?
  approvedAt         DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  approvedBy         User?               @relation("PoApprovedBy", fields: [approvedById], references: [id])
  createdBy          User?               @relation("PoCreatedBy", fields: [createdById], references: [id])
  currency           Currency            @relation(fields: [currencyCode], references: [code])
  supplier           Party               @relation(fields: [supplierId], references: [id])
  warehouse          Warehouse           @relation(fields: [warehouseId], references: [id])
  lines              PurchaseOrderLine[]
  receipts           PurchaseReceipt[]
  invoices           SupplierInvoice[]

  @@index([status])
  @@index([documentDate])
  @@index([supplierId])
}

model PurchaseOrderLine {
  id        String        @id @default(cuid())
  poId      String
  productId String
  unitId    String
  quantity  Decimal       @db.Decimal(18, 4)
  unitPrice Decimal       @db.Decimal(18, 4)
  vatCode   VatRateCode
  notes     String?
  createdAt DateTime      @default(now())
  po        PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)
  product   Product       @relation(fields: [productId], references: [id])
  unit      Unit          @relation(fields: [unitId], references: [id])
  vatRate   VatRate       @relation(fields: [vatCode], references: [code])

  @@index([poId])
  @@index([productId])
}

model PurchaseReceipt {
  id           String                @id @default(cuid())
  documentNo   String                @unique
  documentDate DateTime              @default(now())
  poId         String
  warehouseId  String
  stockMoveId  String?               @unique
  notes        String?
  createdById  String?
  createdAt    DateTime              @default(now())
  createdBy    User?                 @relation("PrCreatedBy", fields: [createdById], references: [id])
  po           PurchaseOrder         @relation(fields: [poId], references: [id])
  stockMove    StockMove?            @relation(fields: [stockMoveId], references: [id])
  warehouse    Warehouse             @relation(fields: [warehouseId], references: [id])
  lines        PurchaseReceiptLine[]
  returns      PurchaseReturn[]

  @@index([poId])
  @@index([documentDate])
}

model PurchaseReceiptLine {
  id                  String               @id @default(cuid())
  receiptId           String
  productId           String
  unitId              String
  quantity            Decimal              @db.Decimal(18, 4)
  notes               String?
  lineSubtotal        Decimal              @db.Decimal(18, 2)
  poLineId            String
  unitPrice           Decimal              @db.Decimal(18, 4)
  vatCode             VatRateCode
  purchaseReturnLines PurchaseReturnLine[]
  product             Product              @relation(fields: [productId], references: [id])
  receipt             PurchaseReceipt      @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  unit                Unit                 @relation(fields: [unitId], references: [id])

  @@index([receiptId])
  @@index([productId])
  @@index([poLineId])
}

model SupplierInvoice {
  id                          String                @id @default(cuid())
  status                      SupplierInvoiceStatus @default(DRAFT)
  documentNo                  String                @unique
  documentDate                DateTime              @default(now())
  supplierId                  String
  poId                        String?
  currencyCode                String
  exchangeRateToBase          Decimal?              @db.Decimal(18, 8)
  subtotal                    Decimal               @default(0) @db.Decimal(18, 2)
  vatTotal                    Decimal               @default(0) @db.Decimal(18, 2)
  grandTotal                  Decimal               @default(0) @db.Decimal(18, 2)

  // keep scalar notes
  notes                       String?

  createdById                 String?
  postedById                  String?
  postedAt                    DateTime?
  createdAt                   DateTime              @default(now())
  updatedAt                   DateTime              @updatedAt
  kind                        InvoiceKind           @default(INVOICE)
  noteOfId                    String?
  noteReason                  String?

  paymentsAllocated           PaymentAllocation[]

  journalEntry   JournalEntry? @relation("SupplierInvoiceJournalEntry", fields: [journalEntryId], references: [id])
  journalEntryId String?       @unique

  purchaseReturn              PurchaseReturn[]      @relation("PurchaseReturnCreditNote")

  createdBy                   User?                 @relation("SiCreatedBy", fields: [createdById], references: [id])
  currency                    Currency              @relation(fields: [currencyCode], references: [code])

  noteOf                      SupplierInvoice?      @relation("SupplierInvoiceNoteOf", fields: [noteOfId], references: [id])

  noteChildren                SupplierInvoice[]     @relation("SupplierInvoiceNoteOf")
  noteEntries                 SupplierInvoiceNote[] @relation("SupplierInvoiceNotes")

  po                          PurchaseOrder?        @relation(fields: [poId], references: [id])
  postedBy                    User?                 @relation("SiPostedBy", fields: [postedById], references: [id])
  supplier                    Party                 @relation(fields: [supplierId], references: [id])
  lines                       SupplierInvoiceLine[]

  @@index([kind])
  @@index([noteOfId])
  @@index([status])
  @@index([supplierId])
  @@index([documentDate])
}

model SupplierInvoiceLine {
  id           String          @id @default(cuid())
  invoiceId    String
  productId    String?
  description  String
  quantity     Decimal         @db.Decimal(18, 4)
  unitPrice    Decimal         @db.Decimal(18, 4)
  vatCode      VatRateCode
  lineSubtotal Decimal         @db.Decimal(18, 2)
  lineVat      Decimal         @db.Decimal(18, 2)
  lineTotal    Decimal         @db.Decimal(18, 2)
  poLineId     String?
  invoice      SupplierInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product      Product?        @relation(fields: [productId], references: [id])
  vatRate      VatRate         @relation(fields: [vatCode], references: [code])

  @@index([invoiceId])
  @@index([poLineId])
}

model SupplierInvoiceNote {
  id        String   @id @default(cuid())
  invoiceId String
  message   String
  createdAt  DateTime @default(now())

  invoice   SupplierInvoice @relation("SupplierInvoiceNotes", fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@index([invoiceId])
}

model Account {
  id        String        @id @default(cuid())
  code      String        @unique
  name      String
  type      AccountType
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  lines     JournalLine[]

  @@index([type])
}

model JournalEntry {
  id             String        @id @default(cuid())
  status         JournalStatus @default(DRAFT)
  documentNo     String        @unique
  documentDate   DateTime      @default(now())
  description    String?
  sourceType     String?
  sourceId       String?
  createdById    String?
  postedById     String?
  postedAt       DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  reversalOfId   String?       @unique
  reversalReason String?
  reversedAt     DateTime?
  reversedById   String?
  createdBy      User?         @relation("JeCreatedBy", fields: [createdById], references: [id])
  postedBy       User?         @relation("JePostedBy", fields: [postedById], references: [id])
  reversalOf     JournalEntry? @relation("JournalReversal", fields: [reversalOfId], references: [id])
  reversal       JournalEntry? @relation("JournalReversal")
  relatedSupplierInvoice SupplierInvoice? @relation("SupplierInvoiceJournalEntry")
  lines          JournalLine[]

  @@index([status])
  @@index([documentDate])
  @@index([sourceType, sourceId])
}

model JournalLine {
  id             String       @id @default(cuid())
  entryId        String
  accountId      String
  description    String?
  debit          Decimal      @default(0) @db.Decimal(18, 2)
  credit         Decimal      @default(0) @db.Decimal(18, 2)
  currencyCode   String?
  amountCurrency Decimal?     @db.Decimal(18, 2)
  createdAt      DateTime     @default(now())
  partyId        String?
  account        Account      @relation(fields: [accountId], references: [id])
  entry          JournalEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  party          Party?       @relation(fields: [partyId], references: [id])

  @@index([entryId])
  @@index([accountId])
  @@index([partyId])
}

model SalesOrder {
  id                       String            @id @default(cuid())
  status                   SalesOrderStatus  @default(DRAFT)
  documentNo               String            @unique
  documentDate             DateTime          @default(now())
  customerId               String
  warehouseId              String
  currencyCode             String
  exchangeRateToBase       Decimal?          @db.Decimal(18, 8)
  notes                    String?
  createdById              String?
  approvedById             String?
  approvedAt               DateTime?
  createdAt                DateTime          @default(now())
  updatedAt                DateTime          @updatedAt
  creditCheckedAt          DateTime?
  creditExposureAtApproval Decimal?          @db.Decimal(18, 2)
  creditOverrideReason     String?
  invoices                 CustomerInvoice[]
  deliveries               SalesDelivery[]
  approvedBy               User?             @relation("SoApprovedBy", fields: [approvedById], references: [id])
  createdBy                User?             @relation("SoCreatedBy", fields: [createdById], references: [id])
  currency                 Currency          @relation(fields: [currencyCode], references: [code])
  customer                 Party             @relation(fields: [customerId], references: [id])
  warehouse                Warehouse         @relation(fields: [warehouseId], references: [id])
  lines                    SalesOrderLine[]

  @@index([status])
  @@index([documentDate])
  @@index([customerId])
}

model SalesOrderLine {
  id        String      @id @default(cuid())
  soId      String
  productId String
  unitId    String
  quantity  Decimal     @db.Decimal(18, 4)
  unitPrice Decimal     @db.Decimal(18, 4)
  vatCode   VatRateCode
  notes     String?
  createdAt DateTime    @default(now())
  product   Product     @relation(fields: [productId], references: [id])
  so        SalesOrder  @relation(fields: [soId], references: [id], onDelete: Cascade)
  unit      Unit        @relation(fields: [unitId], references: [id])
  vatRate   VatRate     @relation(fields: [vatCode], references: [code])

  @@index([soId])
  @@index([productId])
}

model SalesDelivery {
  id           String              @id @default(cuid())
  documentNo   String              @unique
  documentDate DateTime            @default(now())
  soId         String
  warehouseId  String
  stockMoveId  String?             @unique
  notes        String?
  createdById  String?
  createdAt    DateTime            @default(now())
  createdBy    User?               @relation("SdCreatedBy", fields: [createdById], references: [id])
  so           SalesOrder          @relation(fields: [soId], references: [id])
  stockMove    StockMove?          @relation(fields: [stockMoveId], references: [id])
  warehouse    Warehouse           @relation(fields: [warehouseId], references: [id])
  lines        SalesDeliveryLine[]
  returns      SalesReturn[]       @relation("SalesReturnDelivery")

  @@index([soId])
  @@index([documentDate])
}

model SalesDeliveryLine {
  id         String        @id @default(cuid())
  deliveryId String
  productId  String
  unitId     String
  quantity   Decimal       @db.Decimal(18, 4)
  notes      String?
  lineCost   Decimal?      @db.Decimal(18, 2)
  unitCost   Decimal?      @db.Decimal(18, 6)
  delivery   SalesDelivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)
  product    Product       @relation(fields: [productId], references: [id])
  unit       Unit          @relation(fields: [unitId], references: [id])

  @@index([deliveryId])
  @@index([productId])
}

model CustomerInvoice {
  id                 String                @id @default(cuid())
  status             CustomerInvoiceStatus @default(DRAFT)
  documentNo         String                @unique
  documentDate       DateTime              @default(now())
  customerId         String
  soId               String?
  currencyCode       String
  exchangeRateToBase Decimal?              @db.Decimal(18, 8)
  subtotal           Decimal               @default(0) @db.Decimal(18, 2)
  vatTotal           Decimal               @default(0) @db.Decimal(18, 2)
  grandTotal         Decimal               @default(0) @db.Decimal(18, 2)
  createdById        String?
  postedById         String?
  postedAt           DateTime?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  kind               InvoiceKind           @default(INVOICE)
  noteOfId           String?
  noteReason         String?
  createdBy          User?                 @relation("CiCreatedBy", fields: [createdById], references: [id])
  currency           Currency              @relation(fields: [currencyCode], references: [code])
  customer           Party                 @relation(fields: [customerId], references: [id])
  noteOf             CustomerInvoice?      @relation("CustomerInvoiceNoteOf", fields: [noteOfId], references: [id])
  notes              CustomerInvoice[]     @relation("CustomerInvoiceNoteOf")
  postedBy           User?                 @relation("CiPostedBy", fields: [postedById], references: [id])
  so                 SalesOrder?           @relation(fields: [soId], references: [id])
  lines              CustomerInvoiceLine[]
  paymentsAllocated  PaymentAllocation[]

  @@index([kind])
  @@index([status])
  @@index([customerId])
  @@index([documentDate])
  @@index([noteOfId])
}

model CustomerInvoiceLine {
  id           String          @id @default(cuid())
  invoiceId    String
  productId    String?
  description  String
  quantity     Decimal         @db.Decimal(18, 4)
  unitPrice    Decimal         @db.Decimal(18, 4)
  vatCode      VatRateCode
  lineSubtotal Decimal         @db.Decimal(18, 2)
  lineVat      Decimal         @db.Decimal(18, 2)
  lineTotal    Decimal         @db.Decimal(18, 2)
  invoice      CustomerInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product      Product?        @relation(fields: [productId], references: [id])
  vatRate      VatRate         @relation(fields: [vatCode], references: [code])

  @@index([invoiceId])
}

model Payment {
  id                 String              @id @default(cuid())
  status             PaymentStatus       @default(DRAFT)
  documentNo         String              @unique
  documentDate       DateTime            @default(now())
  direction          PaymentDirection
  method             PaymentMethod
  partyId            String
  notes              String?
  currencyCode       String
  exchangeRateToBase Decimal?            @db.Decimal(18, 8)
  amount             Decimal             @db.Decimal(18, 2)
  createdById        String?
  postedById         String?
  postedAt           DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  voidOfId           String?             @unique
  voidReason         String?
  voidedAt           DateTime?
  voidedById         String?
  createdBy          User?               @relation("PayCreatedBy", fields: [createdById], references: [id])
  currency           Currency            @relation(fields: [currencyCode], references: [code])
  party              Party               @relation(fields: [partyId], references: [id])
  postedBy           User?               @relation("PayPostedBy", fields: [postedById], references: [id])
  voidOf             Payment?            @relation("PaymentVoid", fields: [voidOfId], references: [id])
  void               Payment?            @relation("PaymentVoid")
  voidedBy           User?               @relation("PaymentVoidedBy", fields: [voidedById], references: [id])
  allocations        PaymentAllocation[]

  @@index([status])
  @@index([documentDate])
  @@index([partyId])
}

model PaymentAllocation {
  id                String           @id @default(cuid())
  paymentId         String
  customerInvoiceId String?
  supplierInvoiceId String?
  amount            Decimal          @db.Decimal(18, 2)
  customerInvoice   CustomerInvoice? @relation(fields: [customerInvoiceId], references: [id])
  payment           Payment          @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  supplierInvoice   SupplierInvoice? @relation(fields: [supplierInvoiceId], references: [id])

  @@index([paymentId])
}

model FiscalPeriod {
  id         String             @id @default(cuid())
  code       String             @unique
  startDate  DateTime
  endDate    DateTime
  status     FiscalPeriodStatus @default(OPEN)
  closedAt   DateTime?
  closedById String?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  closedBy   User?              @relation("FiscalPeriodClosedBy", fields: [closedById], references: [id])

  @@index([status])
  @@index([startDate, endDate])
}

model SystemSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

model DocumentSequence {
  id           String   @id @default(cuid())
  sequenceCode String
  periodKey    String
  nextNumber   Int      @default(1)
  updatedAt    DateTime @updatedAt

  @@unique([sequenceCode, periodKey])
  @@index([sequenceCode])
}

model InventoryCost {
  id          String    @id @default(cuid())
  productId   String
  warehouseId String
  avgUnitCost Decimal   @db.Decimal(18, 6)
  updatedAt   DateTime  @updatedAt
  product     Product   @relation(fields: [productId], references: [id])
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([productId, warehouseId])
  @@index([warehouseId])
}

model SalesReturn {
  id           String            @id @default(cuid())
  documentNo   String            @unique
  documentDate DateTime          @default(now())
  deliveryId   String
  warehouseId  String
  stockMoveId  String?           @unique
  reason       String
  notes        String?
  createdById  String?
  createdAt    DateTime          @default(now())
  createdBy    User?             @relation("SalesReturnCreatedBy", fields: [createdById], references: [id])
  delivery     SalesDelivery     @relation("SalesReturnDelivery", fields: [deliveryId], references: [id])
  stockMove    StockMove?        @relation("SalesReturnStockMove", fields: [stockMoveId], references: [id])
  warehouse    Warehouse         @relation("SalesReturnWarehouse", fields: [warehouseId], references: [id])
  lines        SalesReturnLine[]

  @@index([deliveryId])
  @@index([documentDate])
}

model SalesReturnLine {
  id          String      @id @default(cuid())
  returnId    String
  productId   String
  unitId      String
  quantity    Decimal     @db.Decimal(18, 4)
  unitCost    Decimal     @db.Decimal(18, 6)
  lineCost    Decimal     @db.Decimal(18, 2)
  notes       String?
  product     Product     @relation("SalesReturnLineProduct", fields: [productId], references: [id])
  salesReturn SalesReturn @relation(fields: [returnId], references: [id], onDelete: Cascade)
  unit        Unit        @relation("SalesReturnLineUnit", fields: [unitId], references: [id])

  @@index([returnId])
  @@index([productId])
}

model InventoryFifoLayer {
  id          String @id @default(cuid())
  productId   String
  warehouseId String

  sourceType   String
  sourceId     String
  sourceLineId String?

  receivedAt DateTime
  qtyIn      Decimal  @db.Decimal(18, 4)
  qtyRemain  Decimal  @db.Decimal(18, 4)

  // valuation in base (TRY)
  unitCostBase Decimal @db.Decimal(18, 6)

  createdAt DateTime @default(now())

  product   Product   @relation(fields: [productId], references: [id])
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])

  allocations InventoryFifoAllocation[]

  @@index([productId, warehouseId, receivedAt])
  @@index([sourceType, sourceId])
}

model InventoryFifoAllocation {
  id          String @id @default(cuid())
  productId   String
  warehouseId String

  issueSourceType   String
  issueSourceId     String
  issueSourceLineId String?

  layerId String

  quantity     Decimal @db.Decimal(18, 4)
  unitCostBase Decimal @db.Decimal(18, 6)
  amountBase   Decimal @db.Decimal(18, 2)

  createdAt DateTime @default(now())

  layer     InventoryFifoLayer @relation(fields: [layerId], references: [id], onDelete: Restrict)
  product   Product            @relation(fields: [productId], references: [id])
  warehouse Warehouse          @relation(fields: [warehouseId], references: [id])

  @@index([productId, warehouseId])
  @@index([issueSourceType, issueSourceId])
  @@index([layerId])
}

model InventoryValuationEntry {
  id          String @id @default(cuid())
  productId   String
  warehouseId String

  sourceType   String
  sourceId     String
  sourceLineId String?

  method InventoryCostMethod @default(FIFO)

  quantityIn  Decimal @default(0) @db.Decimal(18, 4)
  quantityOut Decimal @default(0) @db.Decimal(18, 4)

  amountBase Decimal @db.Decimal(18, 2) // positive for IN, positive for OUT (store absolute)

  createdAt DateTime @default(now())

  product   Product   @relation(fields: [productId], references: [id])
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])

  @@index([productId, warehouseId, createdAt])
  @@index([sourceType, sourceId])
}

model PurchaseReturn {
  id           String   @id @default(cuid())
  documentNo   String   @unique
  documentDate DateTime @default(now())

  receiptId   String
  warehouseId String
  stockMoveId String? @unique

  reason String
  notes  String?

  createdById          String?
  createdAt            DateTime         @default(now())
  supplierCreditNoteId String?
  supplierCreditNote   SupplierInvoice? @relation("PurchaseReturnCreditNote", fields: [supplierCreditNoteId], references: [id])
  receipt              PurchaseReceipt  @relation(fields: [receiptId], references: [id])
  warehouse            Warehouse        @relation(fields: [warehouseId], references: [id])
  stockMove            StockMove?       @relation(fields: [stockMoveId], references: [id])

  createdBy User? @relation("PurchaseReturnCreatedBy", fields: [createdById], references: [id])

  lines PurchaseReturnLine[]

  @@index([receiptId])
  @@index([documentDate])
  @@index([supplierCreditNoteId])
}

model PurchaseReturnLine {
  id            String @id @default(cuid())
  returnId      String
  receiptLineId String

  productId String
  unitId    String
  quantity  Decimal @db.Decimal(18, 4)

  // base TRY snapshot from FIFO allocation at posting time
  unitCostBase Decimal @db.Decimal(18, 6)
  lineCostBase Decimal @db.Decimal(18, 2)

  notes String?

  purchaseReturn PurchaseReturn      @relation(fields: [returnId], references: [id], onDelete: Cascade)
  receiptLine    PurchaseReceiptLine @relation(fields: [receiptLineId], references: [id])
  product        Product             @relation(fields: [productId], references: [id])
  unit           Unit                @relation(fields: [unitId], references: [id])

  @@index([returnId])
  @@index([receiptLineId])
  @@index([productId])
}

/////////////////////////////////////////

enum UserStatus {
  ACTIVE
  DISABLED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  APPROVE
  REJECT
  POST
  CANCEL
  IMPORT
  EXPORT
}

enum PartyType {
  CUSTOMER
  SUPPLIER
}

enum ProductType {
  GOODS
  SERVICE
}

enum VatRateCode {
  KDV_0
  KDV_1
  KDV_10
  KDV_20
}

enum StockMoveType {
  RECEIPT
  ISSUE
  TRANSFER
  ADJUSTMENT
}

enum StockMoveStatus {
  DRAFT
  POSTED
  CANCELED
}

enum PurchaseOrderStatus {
  DRAFT
  APPROVED
  ORDERED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELED
}

enum SupplierInvoiceStatus {
  DRAFT
  POSTED
  CANCELED
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum JournalStatus {
  DRAFT
  POSTED
  CANCELED
}

enum SalesOrderStatus {
  DRAFT
  APPROVED
  CONFIRMED
  PARTIALLY_DELIVERED
  DELIVERED
  CANCELED
}

enum CustomerInvoiceStatus {
  DRAFT
  POSTED
  CANCELED
}

enum PaymentDirection {
  IN
  OUT
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CARD
}

enum PaymentStatus {
  DRAFT
  POSTED
  CANCELED
}

enum FiscalPeriodStatus {
  OPEN
  CLOSED
}

enum InvoiceKind {
  INVOICE
  CREDIT_NOTE
  DEBIT_NOTE
}

enum InventoryCostMethod {
  FIFO
}
